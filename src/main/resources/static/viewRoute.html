<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>특정 경로 보기</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6ee40960f56c83c4e7d4c2e6e3dacd0f&libraries=drawing"></script>
  <style>
    #map {
      width: 100%;
      height: 400px;
      display: none;
    }
    #permissionPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background-color: white;
      border: 1px solid #333;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      text-align: center;
      z-index: 1000;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
  </style>
</head>
<body>
<h1>특정 경로 보기</h1>
<label for="routeId">경로 ID:</label>
<input type="number" id="routeId" placeholder="ID 입력">
<button onclick="showPermissionPopup()">경로 보기</button>

<div id="map"></div>

<!-- 권한 요청 팝업 -->
<div id="overlay"></div>
<div id="permissionPopup">
  <p>GPS 권한을 승인하시겠습니까?</p>
  <button onclick="requestLocation()">예</button>
  <button onclick="closePermissionPopup()">아니요</button>
</div>

<script>
  let map;
  let routeId;

  function showPermissionPopup() {
    routeId = document.getElementById('routeId').value;
    if (!routeId) {
      alert("경로 ID를 입력하세요.");
      return;
    }

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('permissionPopup').style.display = 'block';
  }

  function closePermissionPopup() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('permissionPopup').style.display = 'none';
  }

  function requestLocation() {
    closePermissionPopup();

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        position => {
          loadRoute(position.coords.latitude, position.coords.longitude);
        },
        error => {
          console.error("위치 권한이 거부되었거나 사용할 수 없습니다:", error);
          alert("위치 권한을 허용해 주세요.");
        }
      );
    } else {
      alert("이 브라우저에서는 GPS가 지원되지 않습니다.");
    }
  }

  function loadRoute(userLat, userLng) {
    fetch(`/api/routes/${routeId}`)
      .then(response => response.json())
      .then(route => {
        if (!route.pathData) {
          throw new Error("경로 데이터가 존재하지 않습니다.");
        }

        const pathData = JSON.parse(route.pathData);
        const points = pathData[0].points.map(coord => new kakao.maps.LatLng(coord.y, coord.x));

        document.getElementById('map').style.display = 'block';
        const container = document.getElementById('map');
        const options = {
          center: points[0],
          level: 3
        };
        map = new kakao.maps.Map(container, options);

        const polyline = new kakao.maps.Polyline({
          path: points,
          map: map
        });

        // 사용자 위치 마커 추가
        const userPosition = new kakao.maps.LatLng(userLat, userLng);
        const userMarker = new kakao.maps.Marker({
          position: userPosition,
          map: map
        });
        map.panTo(userPosition); // 사용자 위치로 지도를 이동
      })
      .catch(error => {
        console.error("경로 로드 오류:", error);
        alert("해당 ID의 경로를 찾을 수 없습니다.");
      });
  }
</script>
</body>
</html>
