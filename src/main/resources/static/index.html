<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>경로 저장 및 드로잉</title>
  <script type="text/javascript"
          src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6ee40960f56c83c4e7d4c2e6e3dacd0f&libraries=drawing"></script>
</head>
<body>
<h1>경로 저장</h1>
<button onclick="initializeMap()">지도 초기화 및 경로 그리기</button>
<button onclick="startDrawing()">경로 그리기 시작</button>
<button onclick="saveRoute()">저장</button>
<button onclick="location.href='/gallery.html'">갤러리 보기</button>

<div id="map" style="width:100%; height:400px; display:none;"></div>

<script>
  let map;
  let drawingManager;

  // 지도와 Drawing Manager 초기화
  function initializeMap() {
      document.getElementById('map').style.display = 'block';

      navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const options = {
              center: new kakao.maps.LatLng(lat, lng),
              level: 3
          };
          map = new kakao.maps.Map(document.getElementById('map'), options);

          drawingManager = new kakao.maps.drawing.DrawingManager({
              map: map,
              drawingMode: [kakao.maps.drawing.OverlayType.POLYLINE],
              guideTooltip: ['draw', 'drag', 'edit'],
              polylineOptions: {
                  draggable: true,
                  removable: true,
                  editable: true,
                  strokeColor: '#39f',
                  hintStrokeStyle: 'dash',
                  hintStrokeOpacity: 0.5
              }
          });
      }, () => {
          alert("위치 권한이 필요합니다.");
      });
  }

  // Drawing Manager로 선 그리기 시작
  function startDrawing() {
      drawingManager.select(kakao.maps.drawing.OverlayType.POLYLINE);
  }

  // 그려진 경로 데이터를 서버에 저장
  function saveRoute() {
    const paths = drawingManager.getData().polyline;
    if (paths && paths.length > 0) {
        const routeData = JSON.stringify({ pathData: JSON.stringify(paths) });

        fetch('/api/routes/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: routeData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("서버 오류");
            }
            return response.text(); // 서버 응답을 텍스트 형식으로 반환
        })
        .then(data => {
            if (data) {
                alert(data); // 서버 응답 메시지 표시
            } else {
                alert("경로가 성공적으로 저장되었습니다!"); // 기본 메시지 표시
            }
        })
        .catch(error => console.error("저장 오류:", error));
    } else {
        alert("그려진 경로가 없습니다.");
    }
}

</script>
</body>
</html>
